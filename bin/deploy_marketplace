#!/bin/bash
set -eu

# Flow:
## The Controller is the only unchangeable contract.
## First deploy Arbiter.
## Then send the Arbiter address during Controller deployment.
## Then deploy Controller address during module deployments.

# TODO: For a network_type node open a new shell and run:
# Need to incorporate this into the script.
# `nile node`

# Network:
network_type=localhost
# network_type=mainnet

# localhost is a ShardLabs devnet locally.
# mainnet is currently Goerli/StarkNet-alpha


# Wipe old deployment record if it exists.
rm $network_type.deployments.txt || $echo 'Will create one...'


get_address () {
    # TODO read deployment address from $network_type.deployments.txt
    # Find the line containing the alias $1.
     result=grep -o -m $1 '\b0x\w*'
     echo result
}

# Public keys of wallets (dummy/placeholder)
declare -i AdminPubKey=12345678987654321
declare -i User00PubKey=456456456
echo "here"

# Admin account contract
nile deploy Account $AdminPubKey \
    --alias AdminAccount --network $network_type
    
printf "%s\n" "$(get_address AdminAccount)"
AdminAddress=$(get_address AdminAccount)

# Lords contract 
nile deploy ERC20_Mintable 328287282291 5001796 100000 0 0x227fa3a058b59b952fc989597af12e0687c431e4caf9b09f4aba9d4253ab108 0x227fa3a058b59b952fc989597af12e0687c431e4caf9b09f4aba9d4253ab108 \
    --alias Lords --network $network_type
LordsAddress=$(get_address Lords)

# Realms ERC721 contract
nile deploy ERC721_Mintable 90595379670387 90595379670387 000001 0 0x227fa3a058b59b952fc989597af12e0687c431e4caf9b09f4aba9d4253ab108 \
    --alias Realms --network $network_type
RealmsAddress=$(get_address Realms)

nile deploy bibliotheca_marketplace 0x00a32b798afe12218acc32adb0edbcc0ce964077986c536feb45257676fac2c9 0x07892d5537bf0621f013b4f58ccbd83ebb1bd3ec0938807e2604af974da0c7c0  \
    --alias Realms --network $network_type